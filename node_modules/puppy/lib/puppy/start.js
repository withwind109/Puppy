/**
 * Created by cdtangchao on 2015/9/7
 */
var fs = require('fs'),
    Task = require('./task').Task,
    utils = require('./utils'),
    shelljs = require('shelljs/global'),
    shellConfig = require('shelljs').config,
    Q = require('q');

shellConfig.silent = true;

var PuppyTask = function () {
};

PuppyTask.prototype = new Task();
PuppyTask.prototype.run = function (puppy, argv) {
    if (argv.length < 2) {
        return puppy.fail('Invalid command');
    }

    console.log('c:' + utils.preprocessCliOptions(argv));

    return this.fetchZip({
        targetPath: 'd:/zip_demo/',
        fetchUrl: 'http://127.0.0.1/Framework7-1.2.0.zip'
    })
};


PuppyTask.prototype.fetchZip = function (options) {
    var q = Q.defer();
    console.log('Fetching ZIP from url:', options.fetchUrl, 'to: ', options.targetPath);

    utils.fetchArchive(options.targetPath, options.fetchUrl).then(function () {
        try {
            // Move the content of this repo into the www folder
            //cp('-Rf', options.targetPath+'/.', 'www');

            // Clean up start template folder
            rm('-rf', options.targetPath);
            cd(options.targetPath);

            q.resolve();

        } catch (e) {
            console.error(e);
            q.reject(e);
        }
    }).catch(function (err) {
        console.log(err);
        console.log('Please verify you are using a valid URL or a valid ionic starter.');
        console.log('View available starter templates: `ionic templates`');
    });

    return q.promise;
};


exports.PuppyTask = PuppyTask;